name: CD - Deploy ContÃ­nuo

# Trigger: Executa quando o CI passa e hÃ¡ push na main
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

# PermissÃµes necessÃ¡rias para deploy no GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Garante que apenas um deploy rode por vez
concurrency:
  group: "pages"
  cancel-in-progress: false

# DefiniÃ§Ã£o dos jobs do pipeline
jobs:
  # Job 1: Build para ProduÃ§Ã£o
  build:
    name: Build para ProduÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      # Checkout do cÃ³digo
      - name: Checkout do RepositÃ³rio
        uses: actions/checkout@v4
      
      # PreparaÃ§Ã£o do ambiente de build
      - name: Preparar Ambiente
        run: |
          echo "ğŸ”§ Preparando ambiente de produÃ§Ã£o..."
          echo "Build Number: ${{ github.run_number }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
      
      # Criar diretÃ³rio de build
      - name: Criar Build de ProduÃ§Ã£o
        run: |
          echo "ğŸ”¨ Gerando build de produÃ§Ã£o..."
          mkdir -p _site
          cp -r site/* _site/
          
          # Adiciona informaÃ§Ãµes de build no HTML
          echo "<!-- Build: #${{ github.run_number }} -->" >> _site/index.html
          echo "<!-- Commit: ${{ github.sha }} -->" >> _site/index.html
          echo "<!-- Deploy Date: $(date) -->" >> _site/index.html
          
          echo "âœ… Build de produÃ§Ã£o criado!"
      
      # Listar arquivos do build
      - name: Verificar Artefatos
        run: |
          echo "ğŸ“¦ Artefatos gerados:"
          ls -lah _site/
          echo "Tamanho total: $(du -sh _site/)"
      
      # Configurar Pages
      - name: Configurar GitHub Pages
        uses: actions/configure-pages@v4
      
      # Upload dos artefatos
      - name: Upload de Artefatos
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      # Salvar artefato adicional
      - name: Backup do Build
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ github.run_number }}
          path: _site/
          retention-days: 90

  # Job 2: Deploy no GitHub Pages
  deploy:
    name: Deploy no GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # Deploy para o GitHub Pages
      - name: Publicar no GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # InformaÃ§Ãµes do deploy
      - name: InformaÃ§Ãµes do Deploy
        run: |
          echo "ğŸš€ =========================================="
          echo "ğŸš€ DEPLOY REALIZADO COM SUCESSO!"
          echo "ğŸš€ =========================================="
          echo "âœ… URL: ${{ steps.deployment.outputs.page_url }}"
          echo "âœ… Build: #${{ github.run_number }}"
          echo "âœ… Commit: ${{ github.sha }}"
          echo "âœ… Branch: ${{ github.ref_name }}"
          echo "âœ… Autor: ${{ github.actor }}"
          echo "âœ… Data: $(date)"
          echo "ğŸš€ =========================================="

  # Job 3: VerificaÃ§Ã£o PÃ³s-Deploy
  verify:
    name: VerificaÃ§Ã£o PÃ³s-Deploy
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      # Aguarda alguns segundos para o deploy propagar
      - name: Aguardar PropagaÃ§Ã£o
        run: |
          echo "â³ Aguardando propagaÃ§Ã£o do deploy..."
          sleep 10
          echo "âœ… Deploy deve estar disponÃ­vel!"
      
      # Teste bÃ¡sico de conectividade
      - name: Verificar Deploy
        run: |
          echo "ğŸ” Verificando status do deploy..."
          echo "Site deve estar disponÃ­vel em: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "âœ… Pipeline de CD concluÃ­do com sucesso!"

  # Job 4: RelatÃ³rio Final
  report:
    name: RelatÃ³rio de CD
    runs-on: ubuntu-latest
    needs: verify
    if: always()
    
    steps:
      - name: Gerar RelatÃ³rio Final
        run: |
          echo "ğŸ“Š =========================================="
          echo "ğŸ“Š RELATÃ“RIO DE DEPLOY CONTÃNUO"
          echo "ğŸ“Š =========================================="
          echo "Pipeline: CD - Deploy ContÃ­nuo"
          echo "Status: ConcluÃ­do"
          echo "Build Number: #${{ github.run_number }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
          echo "Evento: ${{ github.event_name }}"
          echo "Data/Hora: $(date)"
          echo "ğŸ“Š =========================================="
          echo "ğŸŒ Site publicado com sucesso!"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“Š =========================================="
      
      - name: MÃ©tricas do Pipeline
        run: |
          echo "ğŸ“ˆ MÃ©tricas:"
          echo "- Total de workflows executados: ${{ github.run_number }}"
          echo "- Tempo de execuÃ§Ã£o: Veja os logs acima"
          echo "- Ambiente: Production (GitHub Pages)"
          echo "- RetenÃ§Ã£o de artefatos: 90 dias"
          echo "âœ… RelatÃ³rio completo!"
